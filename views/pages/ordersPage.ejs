<%- include("../layouts/profileList")  %>

<style>
  p{
    color: #000;
    
  }
  /* Custom styles for modal */
.modal-content {
    border-radius: 10px;
}

.modal-header {
    background-color: #c96;
    color: #fff;
    border-radius: 10px 10px 0 0;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    border-radius: 0 0 10px 10px;
}

/* Adjust close button position */
.close {
    position: absolute;
    right: 20px;
    top: 10px;
    color: #fff;
}

/* Style submit button */
#submitReturn {
    background-color: #28a745;
    border-color: #28a745;
}

#submitReturn:hover {
    background-color: #218838;
    border-color: #1e7e34;
}

/* Style textarea */
textarea.form-control {
    resize: none; /* Prevent resizing of textarea */
}

/* Add margin between buttons */
.modal-footer .btn {
    margin-left: 5px;
    margin-right: 5px;
    
}.order-container{
  overflow-y: auto; /* Enable vertical scrolling */
  scroll-behavior: smooth;
}

</style>


<div class='col-md-9 p-5 right' style=" border-radius:0;">

  <div class="order-container">
    <div class="order-list">
      
  <% if (orderlist.length > 0) { %>
    <% orderlist.slice().reverse().forEach(order => { %>
      
      <ul class="product-list">
              <li class="product-item">
                <div class="product-container">

                  <div class="media" style="display: flex; justify-content: space-between;">
                    
                    <div class="media col-2" style="width: 300px;">
                    <img style="width: 100px; height: 100px;" src="/uploads/<%= order.productDetail.image[0] %>" class="mr-3 order-image" alt="<%= order.productDetail.name %>">
                  </div>
                    <div class="media-body" style="width: 33%; flex: none;">
                      <h5 class="mt-0"><%= order.productDetail.name %></h5>
                      <p style="font-weight: 500;">₹<%= order.totalAmount %></p>
                      <p>Quantity: <%= order.products.quantity %></p>
                    </div>

                    <div>
                      <!-- <p><%= order.orderDate.toString().split(' ').slice(0, 4).join(' ') %></p> -->
                      <p style="font-size: larger; font-weight: 400;"><%= order.paymentMethod %></p>

                      <p><a href="/profile/myorders/orderDetails/<%= order._id %>"><button class="btn btn-primary">View Details</button></a></p>


                      <p style="font-size: larger; font-weight: 400;">Status: <span style="color: rgb(73, 213, 75);" id="deliveryStatus_<%= order.products._id %>"><%= order.products.status %></span></p>
                    </div>

                    <!-- cancel and return -->
                    <div class="container">
                      <div class="row justify-content-center">
                          <div class="col-md-6 text-center">
                              <br>
                              <% if (order.products.status === 'Delivered') { %>
                                <button class="btn btn-dark return-order-btn" style="margin-top: 5px;" data-order-id="<%= order._id %>" data-order-name="<%= order.productDetail.name %>" data-order-amount="<%= order.totalAmount %>" data-toggle="modal" data-target="#returnModal">Return Order</button>
                                
                              <% } else if (order.products.status === 'Cancelled') { %>
                                  <span class="can" style="font-size: larger; color: red;">Order Cancelled</span>
                              <% } else if (order.products.status === 'Returned') { %>
                                  <span class="can" style="font-size: larger;">Returned</span>
                              <% } else { %>
                                <button class="btn btn-danger cancel-order-btn" data-order-id="<%= order._id %>" data-order-name="<%= order.productDetail.name %>" data-order-amount="<%= order.totalAmount %>" data-toggle="modal" data-target="#cancelOrder">Cancel Order</button>
                              <% } %>
                          </div>
                      </div>
                  </div>
                  
                  

                         <!-- Modal for cancelling order -->
                        <!-- <div class="modal fade" id="cancelOrderModal" tabindex="-1" role="dialog" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
                          <div class="modal-dialog modal-dialog-centered" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" style="color: #fff;" id="cancelOrderModalLabel">Cancel Order</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                  <span aria-hidden="true">&times;</span>
                                </button>
                              </div>
                              <div class="modal-body">
                                <p><strong>Order Name:</strong> <span id="cancelOrderName"></span></p>
                                <p><strong>Total Amount:</strong> ₹<span id="cancelOrderAmount"></span></p>
                                <form id="cancelOrderForm">
                                  <div class="form-group">
                                    <label for="cancelReason">Reason:</label>
                                    <textarea class="form-control" id="cancelReason" rows="5" placeholder="Enter reason for cancellation" required></textarea>
                                  </div>
                                </form>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" id="submitCancelOrder">Submit</button>
                              </div>
                            </div>
                          </div>
                        </div> -->



                        <!-- Modal for reason of return -->
                        <div class="modal fade" id="returnModal" tabindex="-1" role="dialog" aria-labelledby="returnModalLabel" aria-hidden="true">
                          <div class="modal-dialog modal-dialog-centered" role="document">
                              <div class="modal-content">
                                  <div class="modal-header">
                                      <h5 class="modal-title" style="color: #fff;" id="returnModalLabel">Return Order Details</h5>
                                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                          <span aria-hidden="true">&times;</span>
                                      </button>
                                  </div>
                                  <div class="modal-body">
                                      <p><strong>Order Name:</strong> <span id="orderName"></span></p>
                                      <p><strong>Total Amount:</strong> ₹<span id="orderAmount"></span></p>
                                      <!-- Form for entering reason of return -->
                                      <form id="returnForm">
                                          <div class="form-group">
                                              <label for="reason">Reason:</label>
                                              <textarea class="form-control" id="reason" rows="5" placeholder="Enter reason for return" required></textarea>
                                          </div>
                                      </form>
                                  </div>
                                  <div class="modal-footer">
                                      <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                                      <button type="button" class="btn btn-primary" id="submitReturn">Submit</button>
                                  </div>
                              </div>
                          </div>
                        </div>


                  </div>
                  <br><br>
                </div>
              </li>
            <% }) %>
          </ul>
        </div>
    <% } else { %>
      <p>No orders found.</p>
    <% } %>
  </div>
  

    
          


  <!-- profileList end div        -->
</div>
</div>
 <!-- profileList end div        -->

 
<br>
<br>
<%- include("../layouts/mobileNav") %>
<%- include("../layouts/footer")  %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>




<!-- order cancel in user side -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
  
    document.querySelectorAll('.cancel-order-btn').forEach(button => {
      button.addEventListener('click', () => {
        const orderId = button.dataset.orderId;
        const statusElement = document.getElementById(`deliveryStatus_${orderId}`);
        
        
        if (statusElement && statusElement.textContent.trim() === 'Cancelled') {
          Swal.fire('Already Cancelled!', 'This order has already been cancelled.', 'info');
          return; 
        }
        
       
        Swal.fire({
        title: 'Are you sure?',
        text: 'Cancel the Order!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, cancel it!',
        cancelButtonText: 'No, keep it'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/orders/${orderId}/cancel`, {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    Swal.fire('Cancelled!', 'Your order has been cancelled.', 'success')
                    .then(() => {
                        window.location.href = '/profile/myorders';
                    });
                } else {
                    Swal.fire('Error!', 'Failed to cancel the order.', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error!', 'Failed to cancel the order.', 'error');
            });
        }
    });

      });
    });
  });
</script>


<!-- return order modal -->
<script>

document.querySelectorAll('.return-order-btn').forEach(button => {
    button.addEventListener('click', function() {
    
        orderName = this.dataset.orderName;
        orderAmount = this.dataset.orderAmount;
        const orderId = this.dataset.orderId; 

        document.getElementById('orderName').textContent = orderName;
        document.getElementById('orderAmount').textContent = orderAmount;
        console.log(orderName, orderAmount, orderId);
    });
});

// Reason modal
document.addEventListener('DOMContentLoaded', function() {
    const returnBtn = document.querySelector('.return-order-btn');
    const returnModal = document.getElementById('returnModal');

    returnBtn.addEventListener('click', function() {
        
        $(returnModal).modal('show');
    });

    const submitReturnBtn = document.getElementById('submitReturn');
    submitReturnBtn.addEventListener('click', function() {
        const reason = document.getElementById('reason').value.trim();
        const orderId = document.querySelector('.return-order-btn').dataset.orderId; // Retrieve the order ID

        if (reason.trim() === '') {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Please enter a reason for return!',
            });
        } else {
    
            var data = {
                reason: reason,
                orderAmount: orderAmount,
                orderId: orderId 
            };

           
            fetch('/profile/myorders/returnOrder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Return submitted successfully.',
                });
                $('#returnModal').modal('hide'); 
                // Reset the form
                $('#returnForm')[0].reset();

                // Update the UI to reflect the new status
                // Assuming the return order button has a class 'return-order-btn'
                const returnOrderButton = document.querySelector('.return-order-btn');
                if (returnOrderButton) {
                    returnOrderButton.style.display = 'none'; // Hide the return order button
                }
                // Show a "Return Pending" message
                const returnPendingMessage = document.createElement('span');
                returnPendingMessage.textContent = 'Return Pending';
                returnPendingMessage.style.fontSize = 'larger';
                // returnPendingMessage.style.color = 'red';  
                returnPendingMessage.classList.add('can'); // Assuming 'can' is a class for styling
                document.querySelector('.text-center').appendChild(returnPendingMessage); // Assuming the button is inside a '.text-center' div
            })

            .catch(error => {
                // Show error alert
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'There was an error submitting the return. Please try again later.',
                });
                console.error('There was an error:', error);
            });
        }
    });
});

</script>

  